<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VoFo Music</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #745dc7; --bg: #0a0a0a; --card: #181818; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; }

        /* Background Fix: Pointer-events none ensures search bar works */
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at top, #1a1a2e, #0a0a0a); }

        .top-bar {
            position: sticky; top: 0; height: 80px;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 0 40px;
            z-index: 1000; border-bottom: 1px solid #222;
        }

        .search-box { display: flex; gap: 10px; width: 400px; z-index: 1001; }
        #searchInput { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #333; background: #111; color: white; outline: none; }
        #searchBtn { background: var(--primary); border: none; padding: 0 25px; border-radius: 25px; color: white; cursor: pointer; font-weight: bold; }

        /* RESULTS GRID */
        #results { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px; 
            padding: 40px; 
        }

        .song-card { 
            background: var(--card); padding: 15px; border-radius: 12px; 
            cursor: pointer; transition: 0.3s; 
        }
        .song-card:hover { background: #282828; transform: translateY(-5px); }
        
        /* THE PHOTO */
        .song-card img { 
            width: 100%; 
            aspect-ratio: 1/1; 
            border-radius: 8px; 
            object-fit: cover; 
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .song-title { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { color: #b3b3b3; font-size: 12px; }

        /* PLAYER BAR */
        .player-bar {
            position: fixed; bottom: 0; width: 100%; height: 90px;
            background: #000; display: flex; align-items: center; 
            padding: 0 30px; border-top: 1px solid #333; z-index: 1002;
            box-sizing: border-box;
        }
        .hidden { display: none; }
        #playerThumb { width: 55px; height: 55px; border-radius: 5px; margin-right: 15px; object-fit: cover; }
    </style>
</head>
<body>

<div class="vignette"></div>

<div class="top-bar">
    <h1 style="margin-right: auto; color: var(--primary);">VoFo</h1>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search music..." autocomplete="off">
        <button id="searchBtn" onclick="doSearch()">Search</button>
    </div>
</div>

<div id="results"></div>

<div class="player-bar hidden" id="player">
    <img id="playerThumb" src="">
    <div style="width: 200px; margin-right: 20px;">
        <div id="trackTitle" class="song-title"></div>
        <div id="trackArtist" class="song-artist"></div>
    </div>
    <audio id="audio" controls style="flex: 1; filter: invert(0.9);"></audio>
</div>

<script>
    const audio = document.getElementById('audio');
    let hls = null;

    async function doSearch() {
        const q = document.getElementById('searchInput').value;
        if(!q) return;
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        
        data.forEach(song => {
            const div = document.createElement('div');
            div.className = 'song-card';
            div.innerHTML = `
                <img src="${song.thumbnail}">
                <div class="song-title">${song.title}</div>
                <div class="song-artist">${song.artist}</div>
            `;
            div.onclick = () => playSong(song);
            resultsDiv.appendChild(div);
        });
    }

    async function playSong(song) {
        document.getElementById('player').classList.remove('hidden');
        document.getElementById('trackTitle').innerText = song.title;
        document.getElementById('trackArtist').innerText = song.artist;
        document.getElementById('playerThumb').src = song.thumbnail;

        const res = await fetch('/api/play', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: song.id })
        });
        const data = await res.json();
        
        if (hls) { hls.destroy(); hls = null; }

        if (Hls.isSupported() && data.stream_url.includes('.m3u8')) {
            hls = new Hls();
            hls.loadSource(data.stream_url);
            hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play());
        } else {
            audio.src = data.stream_url;
            audio.play();
        }
    }

    document.getElementById("searchInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
    });
</script>
</body>
</html>
